在这一章节里，我们将会完成本合约，创建一个用于退回买家给出的拍卖价格的函数和一个用于结束此次拍卖的函数。

### Withdraw
我们创建一个局部变量 `bal`（balance）用于保存从上一次退款之后，该函数的调用者们所开出的所有价的总值（第 75 行）。只要以函数调用者的地址为键访问映射 `bids` 即可得到对应的总值，并将之赋予变量 `bal`。

随后，我们在 `bids` 中将该地址对应的出价设置为 0，因为他们会撤回他们的出价（第 76 行）。

现在我们把对应数量的 ETH 从合约转移给函数调用者并发送 `Withdraw` 事件（第 79 行）。

### End
在该函数被执行之前，我们需要确保以下条件得到了满足。此次拍卖已经开始（第 83 行），已经达到了此次拍卖的截止日期（第 84 行），此次拍卖还未结束（第 85 行）。

一旦此次拍卖结束了，我们将变量 `ended` 设置为 `true`（第 87 行）。

我们检查是否有人参与了此次拍卖并为 NFT 出了价（第 88 行）。

如果有出价，我们把 NFT 转移给出价最高的人（第 89 行）并且把之前他用于竞拍而转移给该合约的 ETH 转移给拍卖者，也就是 NFT 的卖家（第 90 行）。

如果没有人竞拍这个 NFT，我们就会把 NFT 退还给拍卖者（第 92 行）。

最后，我们发送 `End` 事件（第 95 行）。

## ⭐️ 实操练习

1. 部署一个 NFT 合约。你可以使用我们在 "Solidity NFT Course" 这一章节中创建的智能合约。

2. 给自己分配一个 tokenId 为 0 的 NFT。

3. 为了测试一下，把状态变量 `endAt`（第 54 行）从 `7 days` 修改为 `5 minutes`。

4. 部署这个 EnglishAuction 合约。将参数 `_nft` 设置为上一步部署的 NFT 合约的地址，将参数 `_nftId` 设置为 0，参数 `_startingBid` 设为 1。

5. 调用 NFT 合约的 `approve` 方法，将参数 `to` 设置为拍卖合约的地址，将参数 `tokenId` 设置为 0。

6. 调用拍卖合约的 `start` 方法。

7. 用账户 1 开价 2 ETH，账户 2 开价 3 ETH。如果你调用 `highestBidder` 函数，应该会返回账户 2 的地址。

8. 用账户 1 调用 `withdraw` 函数。在账户 1 的余额上，你应该看到 2 ETH 再扣除一些交易费。

9. 5 分钟之后，调用 `end` 函数。然后调用 `ended` 方法，它应该会返回 `true`。

在 NFT 合约中，如果你调用 `ownerOf` 函数去查询 tokenId 为 0 的 NFT，他应该返回的是账户 2 的地址。如果你查看账户 1 的余额，它应该会增加 3 Ether 再扣除一些交易产生的费用。
